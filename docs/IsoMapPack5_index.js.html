<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: IsoMapPack5/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: IsoMapPack5/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const lzo = require('lzo');
const Tile = require('./tile');

const metaSize = 4;
const maxChunkSize = 8192;

let t1 = [ ],
	t2 = [ ];

/**
 * A parsers for the [IsoMapPack5] ini section
 *
 * @namespace IsoMapPack5
 *
 * @property {Tile} Tile - Tile Class
 * @property {Number} MetaSize - The length of the metadata for each chunk
 * @property {Number} MaxChunkSize - The maximum length that a chunk can be
 */
class IsoMapPack5 {

	/**
	 *	Parses data from the IsoMapPack5 ini section
	 *
	 *	@static
	 *
	 *	@param {Buffer} data - The base64-decoded data
	 *
	 *	@return {Array.&lt;Tile>} The parsed tiles
	 */
	static parse(data) {
		let rawData = new Buffer(0),
			tiles = [ ],
			tileBuf;

		// As long as stere are chunks left, decompress them and push them to rawData
		while(data.length > 0) {
			let in_len = data.readUInt16LE(0),
				out_len = data.readUInt16LE(2),
				chunk = lzo.decompress( data.slice(metaSize, metaSize + in_len), out_len );

			t1.push({ in_len, out_len });

			rawData = Buffer.concat([ rawData, chunk ]);
			data = data.slice(metaSize + in_len);
		}

		// Parse all the tiles! http://goo.gl/ULOjhn
		while(rawData.length > 0) {
			tileBuf = rawData.slice(0, Tile.DataLength);

			tiles.push(new Tile(
				tileBuf.readInt16LE(0), // x-Coordinate
				tileBuf.readInt16LE(2), // y-Coordinate
				tileBuf.readUInt32LE(4), // TileTypeIndex
				tileBuf[8], // TileSubtypeIndex
				tileBuf[9], // Level (Height)
				tileBuf[10] // Unknown
			));

			rawData = rawData.slice(Tile.DataLength);
		}

		return tiles;
	}

	/**
	 * Make the data obtained by ini.parse ready for IsoMapPack5.parse
	 *
	 * @static
	 *
	 * @param {Object} section - The parsed ini section
	 */
	static __parse(section) {
		let lines = [ ];

		for(const line in section)
			lines.push(section[line]);

		return IsoMapPack5.parse( new Buffer(lines.join(''), 'base64') );
	}

	/**
	 *	Serializes an Array of tiles
	 *
	 *	@static
	 *
	 *	@param {Array.&lt;Tile>} tiles - An array of tiles
	 *
	 *	@return {Buffer} The compressed and encoded data
	 */
	static serialize(tiles) {
		let rawData = new Buffer(tiles.length * Tile.DataLength),
			offset;

		// Concat all tiles into one Buffer
		tiles.forEach((tile, i) => {
			offset = i * Tile.DataLength;

			rawData.writeInt16LE(tile.x, offset);
			rawData.writeInt16LE(tile.y, offset + 2);
			rawData.writeUInt32LE(tile.type, offset + 4);
			rawData[offset + 8] = tile.subtype;
			rawData[offset + 9] = tile.height;
			rawData[offset + 10] = tile.unknown;
		});

		let compressedData = new Buffer(0),
			meta = new Buffer(metaSize); // Allocate the memory for metadata only once, not for every chunk

		// Split the data into chunks and compress them
		while(rawData.length > 0) {
			let chunk = rawData.slice(0, maxChunkSize),
				compressed = lzo.compress(chunk),
				out_len = chunk.length,
				in_len = compressed.length;

			t2.push({ in_len, out_len });

			meta.writeUInt16LE(in_len, 0);
			meta.writeUInt16LE(out_len, 2);

			compressedData = Buffer.concat([ compressedData, meta, compressed ]);

			rawData = rawData.slice(out_len);
		}

		// t1.forEach((v, i) => console.log('Chunk #' + (i + 1), '-- Read from file:', v, '-- Serialized:', t2[i]));

		return compressedData;
	}

}

IsoMapPack5.Tile = Tile;
IsoMapPack5.MetaSize = metaSize;
IsoMapPack5.MaxChunkSize = maxChunkSize;

module.exports = IsoMapPack5;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Tile.html">Tile</a></li></ul><h3>Namespaces</h3><ul><li><a href="IsoMapPack5.html">IsoMapPack5</a></li><li><a href="Parser.html">Parser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed May 11 2016 18:43:56 GMT+0200 (Mitteleurop√§ische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
